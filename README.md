# Интерактивная схема зданий (plan-Universal)

Веб‑приложение для визуализации занятости помещений на планах этажей с данными из Excel. Позволяет:
- загружать Excel (.xls/.xlsx) с данными о помещениях,
- автоматически парсить и сохранять данные в JSON,
- подсвечивать помещения на SVG‑схемах цветами «свободно/занято/особые/синие»,
- показывать подробную информацию о помещении,
- отображать исходный Excel (последний загруженный) прямо на странице.

### Основные возможности
- Авторизация и защита API/страниц (PHP‑сессии + проверка на клиенте).
- Импорт Excel: поддержка .xls и .xlsx (библиотеки Shuchkin SimpleXLS/ SimpleXLSX).
- «Синие помещения» через конфигурацию `blue-rooms-config.json`.
- Поля «Площадь», «Площадь по договору» и расчёт «Стоимость квадратного метра» = Сумма аренды / Площадь по договору.
- Просмотр последнего Excel в `iframe`.

## Быстрый старт

### Требования
- PHP 7.4+ (рекомендуется PHP 8.x)
- Расширение zlib (для распаковки .xlsx)
- Веб-сервер Apache/Nginx ИЛИ встроенный PHP‑сервер

### Развёртывание
1. Скопируйте проект в директорию веб‑сервера, напр.: `/var/www/plan-Universal`.
2. Убедитесь, что каталоги `uploads/` и `data/` доступны для записи пользователю веб‑сервера:
   ```bash
   sudo chown -R www-data:www-data /var/www/plan-Universal/{uploads,data}
   sudo chmod -R 775 /var/www/plan-Universal/{uploads,data}
   ```
3. Apache: включите поддержку `.htaccess` (AllowOverride All) или настройте эквивалент в Nginx.
   - В проекте уже есть `.htaccess` c `DirectoryIndex login.html index.html`.

Альтернатива (встроенный PHP‑сервер):
```bash
cd /var/www/plan-Universal
php -S 0.0.0.0:8000
```
Откройте `http://<server>:8000`.

### Доступ и логин
- Страница входа: `login.html`
- По умолчанию:
  - Логин: `admin`
  - Пароль: `Pbey*n`
- После входа доступны главная страница, импорт, API.

## Структура проекта
```
/var/www/plan-Universal
├── api.php                    # API: загрузка и данные из Excel (JSON)
├── index.html                 # Главная страница приложения
├── index.php                  # Защита/роутинг статических файлов
├── login.html                 # Страница входа
├── login.php                  # Обработчик логина (PHP‑сессии)
├── logout.php                 # Выход из сессии
├── styles.css                 # Стили
├── script.js                  # Логика фронтенда
├── table.php                  # Просмотр последнего Excel в iframe
├── blue-rooms-config.json     # Конфигурация «синих помещений»
├── blue-rooms-dialog.txt      # История диалога по фичам (служебно)
├── floor_plan_svg/            # SVG‑схемы этажей
├── libs/                      # SimpleXLS / SimpleXLSX
├── uploads/                   # Залитые Excel файлы (пишется приложением)
└── data/
    └── rooms.json             # Сохранённые данные из Excel (пишется приложением)
```

## Аутентификация
- Клиент: хранит флаг `localStorage.isAuthenticated` и имя пользователя.
- Сервер: проверка `$_SESSION['isAuthenticated']` в `index.php`, `api.php`, `table.php`.
- SVG‑файлы в `floor_plan_svg/` доступны без редиректа для корректной загрузки схем.

## Работа с данными
### Импорт Excel
1. В блоке «Импорт данных из Excel» выберите файл `.xls`/`.xlsx` и нажмите «Загрузить и обновить».
2. Файл сохраняется в `uploads/` и парсится.
3. Результат сохраняется в `data/rooms.json` и тут же подхватывается интерфейсом.

### Требования к Excel
Приложение ожидает столбцы (гибкие по названиям, используется эвристика):
- «Объект недвижимости» — строка с текстом, содержащим номер помещения вида `№ 101`, а также фразы вида `строение 19/2`, `этаж`, `подвал`.
- «Контрагент» (или «Арендатор») — имя арендатора.
- «Договор» — номер/дата договора.
- «Сумма» — арендная плата (месячная), может содержать пробелы, запятые и «руб.».
- «Статус» — текст, по которому определяется занятость (например, «В аренде», «Занято»).
- «Площадь» — общая площадь (опционально).
- «Площадь по договору» — площадь из договора (для расчёта ставки).

Эвристики парсинга:
- Номер помещения извлекается по шаблону `№\s*(\d+[А-Яа-я]?)` из «Объект недвижимости».
- Номер строения из `строение X` или `строение X/Y` → `X` или `X-Y`.
- Этаж: «подвал/цоколь» → `floor-0`; иначе определяется по заголовкам «этаж» в соседних строках.
- Занятость: по «Статусу» (содержит «аренд» или «занят») либо по самому факту наличия контрагента.

### Структура JSON
Каждый объект в `rooms.json` имеет поля:
```json
{
  "number": "101",
  "building": "19",
  "floor": "floor-1",
  "tenant": "ИП Иванов",
  "contract": "12/34 от ...",
  "rent": "25 596,16",
  "area": "45,3",
  "contractArea": "45,3"
}
```

## API
`api.php` защищён сессией (401 без авторизации).

- GET `/api.php`
  - Возвращает `rooms.json` как массив объектов.
  - Пример ответа: `[{...}, {...}]`.

- POST `/api.php`
  - Принимает форму с полем файла `file` (`.xls`/`.xlsx`).
  - Парсит и сохраняет `data/rooms.json`. Возвращает массив объектов.

Коды ошибок: `400` (ошибка загрузки/парсинга), `401` (Unauthorized), `415` (тип файла), `500` (ошибка сервера), `405` (Method not allowed).

## Отображение и взаимодействие
- SVG‑схемы в `floor_plan_svg/` имеют id помещений вида `room-<номер>`. Коридоры — `corridor*`.
- Цвета:
  - Свободно — зелёный (`.free`),
  - Занято — красный (`.occupied`),
  - Синие помещения — голубой (`.blue-room`),
  - Особые — голубой (`.special-room`).
- По клику на помещение отображается информация: номер, здание, этаж, статус, арендатор/договор/плата, площади.
- «Стоимость квадратного метра»: автоматически считается как `rent / contractArea` и выводится в «руб./м²», если оба значения распознаны как числа.

## Конфигурация «синих помещений»
Файл `blue-rooms-config.json`:
```json
{
  "blueRooms": [
    { "building": "building-19",   "floor": "floor-0", "rooms": ["1", "5б", "6а"] },
    { "building": "building-19-2", "floor": "floor-2", "rooms": ["27"] }
  ]
}
```
Значения `building`/`floor` должны соответствовать ключам в приложении, номера помещений — как на схеме (поддерживаются суффиксы «а/б/в»).
Приложение использует кэш‑бейкинг (`?nocache=<rand>`) при загрузке конфигурации, но при правках файла рекомендуем обновлять страницу с очисткой кэша (Ctrl+F5).

## Просмотр исходной таблицы
`table.php` находит последний загруженный Excel в `uploads/` и рендерит первый лист в виде HTML‑таблицы.
На главной странице через `iframe` видно актуальный источник данных.

## Ключевые файлы
- `index.html` — интерфейс: переключение зданий/этажей, легенда, панель информации, импорт, просмотр Excel.
- `script.js` — логика: загрузка SVG, обработка кликов, статус помещений, подсветка «синих»/особых, расчёт стоимости м².
- `styles.css` — стили для адаптивного интерфейса, легенды, панели информации.
- `index.php` — проверка сессии и отдача статических файлов с корректными MIME.
- `api.php` — импорт/экспорт данных, парсинг Excel, сохранение `rooms.json`.
- `libs/` — сторонние библиотеки парсинга Excel (© Sergey Shuchkin, MIT License).

## Безопасность и рекомендации
- Доступ к приложению защищён сессиями, но пароли и сессии демонстрационные — доработайте для продакшена (хранение паролей, HTTPS, таймауты).
- Убедитесь, что только `uploads/` и `data/` доступны для записи веб‑серверу.
- Отключена индексация каталогов (`.htaccess: Options -Indexes`).

## Устранение неполадок
- «Синие помещения» не отображаются:
  - Проверьте `blue-rooms-config.json` и обновите страницу с очисткой кэша.
- «Площадь»/«Площадь по договору» не видны:
  - Повторно загрузите Excel после обновления кода — старый `rooms.json` может не содержать этих полей.
- «Стоимость квадратного метра» не показывается:
  - Проверьте, что в данных есть и корректно распознаются `rent` и `contractArea` (числа). Допустимы форматы с пробелами и запятыми.
- 401 Unauthorized:
  - Повторите вход. Проверьте, что включены cookies и сессии PHP.
- Проблемы с загрузкой файла:
  - Проверьте права на `uploads/` и `data/`.

## Лицензии и благодарности
- Парсинг Excel: [SimpleXLSX](https://github.com/shuchkin/simplexlsx) и [SimpleXLS](https://github.com/shuchkin/simplexls) — MIT License, © Sergey Shuchkin.

---
Если нужна помощь с интеграцией других форматов данных, дополнительными слоями отображения или автоматической синхронизацией с Google Sheets — можно расширить текущее API/клиент.
