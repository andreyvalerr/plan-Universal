# Интерактивная схема зданий (plan-Universal)

Веб‑приложение для визуализации схем этажей зданий на основе SVG с интеграцией Google Таблиц. Приложение подсвечивает помещения по их статусу (свободно/занято), показывает подробности по клику и поддерживает «синие» помещения, задаваемые через конфигурационный файл. Доступ к интерфейсу защищён авторизацией.

## Возможности

- Отображение SVG‑схем этажей для нескольких зданий (19, 19‑1, 19‑2)
- Переключение здания и этажа через панели управления
- Подсветка статуса помещений:
  - зелёный — свободно
  - красный — занято (есть арендатор в данных)
  - синий — помещения, явно перечисленные в конфиге
- Показ подробной информации по клику на помещение (арендатор, договор, сумма)
- Поддержка буквенных суффиксов в номерах (12а, 6б и т. п.) и корректная нормализация кириллица/латиница
- Учёт одноимённых помещений на разных этажах/в разных строениях
- Автообновление подложки (SVG) при переключении и повторная подсветка для стабильности
- Интеграция с Google Apps Script (получение данных из Google Таблиц)
- Защита доступа: клиентская (localStorage) + серверная (PHP‑сессии)

## Архитектура и ключевые файлы

- `index.html` — разметка интерфейса, переключатели здания/этажа, легенда, контейнер карты, iframe опубликованной таблицы
- `styles.css` — оформление интерфейса, состояния помещений (`.free`, `.occupied`, `.blue-room`, `.special-room`), адаптив
- `script.js` — логика клиента: авторизация, загрузка SVG, получение и нормализация данных, окраска помещений, «синие» и «особые» помещения
- `blue-rooms-config.json` — конфигурация «синих» помещений
- `floor_plan_svg/` — набор SVG‑схем (имена и id важны, см. ниже)
- `login.html` / `login.php` / `logout.php` — формы и обработчики входа/выхода
- `index.php` — лёгкий роутер/защита сервером (перенаправление неавторизованных на `login.html`, раздача статики с корректным MIME)
- `.htaccess` — `DirectoryIndex`, запрет просмотра каталогов и запрет прямого доступа к `google-apps-script.js`
- `google-apps-script.js` — код для Apps Script (бэкенд к Google Таблицам)

### Основные функции `script.js`

- `checkAuth()` — проверка клиентской авторизации, навигация на страницу входа, обработчик «Выйти»
- `init()` — начальная инициализация интерфейса, загрузка стартового SVG, данных, обработчиков
- `loadSVG(filename)` — загрузка SVG из папки `floor_plan_svg`
- `createMapWrappers()` / `loadCurrentMap()` / `updateActiveMap()` — управление контейнерами схем и их содержимым
- `setupEventListeners()` / `setupRoomEventListeners()` — обработчики UI и кликов по помещениям
- `fetchDataFromGoogleSheets()` — получение JSON с данными из Apps Script (или мок‑данные при ошибке)
- `normalizeRoomNumber()` / `translateLatinToCyrillic()` — нормализация номера помещения и замена латиницы на кириллицу (a→а, b→б, c→в, d→д, e→е, o→о)
- `updateRoomStatus()` — вычисление состояния и окраска помещений (с учётом «синих»)
- `displayRoomInfo()` / `displayRoomInfoData()` / `displayEmptyRoomInfo()` — показ карточки помещения
- `loadBlueRoomsConfig()` / `getDefaultBlueRooms()` / `shouldBeBlue()` — конфигурация и логика «синих» помещений
- `updateSpecialRoomsHighlight()` — подсветка «особых» помещений из массива `specialRooms`

## Установка и запуск

### Требования

- Любой статический HTTP‑сервер. Для надёжной защиты — PHP 7.0+
- Современный браузер

### Запуск (рекомендуется, с поддержкой PHP)

1. Установите PHP (7.0+)
2. В корне проекта выполните:
   ```bash
   php -S localhost:8000
   ```
3. Откройте `http://localhost:8000`

### Запуск (без PHP, упрощённо)

Подойдёт только для клиентской части (localStorage). Серверная защита и PHP‑маршрутизация работать не будут.

- Python:
  ```bash
  python -m http.server 8000
  ```
- Node.js http-server:
  ```bash
  npx http-server -p 8000
  ```

### Деплой на веб‑сервер

1. Скопируйте файлы в `DocumentRoot` (например, `/var/www/html`)
2. Убедитесь, что `.htaccess` применяется (Apache: включён `AllowOverride`)
3. При использовании виртуальных хостов пропишите `DirectoryIndex login.html index.html`
4. Измените учётные данные по умолчанию (см. ниже)

## Авторизация

- Страница входа: `login.html`
- Обработчик: `login.php` (создаёт PHP‑сессию)
- Выход: `logout.php`
- Серверная проверка: `index.php` перенаправляет неавторизованных на `login.html` (SVG из `floor_plan_svg/` всегда доступны для корректной загрузки карты)

### Учётные данные по умолчанию

- Логин: `admin`
- Пароль: `Pbey*n`

Изменить пароль можно в `login.php`:

```php
$validUsername = 'admin';
$validPassword = 'Pbey*n';
```

Клиент хранит флаг входа в `localStorage` и показывает имя пользователя в верхней панели.

## Интеграция с Google Таблицами

Приложение получает данные через опубликованный Google Apps Script, код которого находится в `google-apps-script.js`.

1. Откройте Google Таблицу с данными и вставьте код из `google-apps-script.js` в редакторе Apps Script
2. Укажите `spreadsheetId`
3. Разверните как «Веб‑приложение» с доступом «Все, даже анонимные»
4. Скопируйте URL развертывания и пропишите его в `script.js`:

```javascript
const API_URL = 'https://script.google.com/macros/s/ВАШ_ID/exec';
```

В `index.html` по умолчанию встроен iframe опубликованной таблицы — это вариант для визуального просмотра, на логику подсветки он не влияет.

### Что извлекает Apps Script

- Номер помещения (включая букву)
- Строение (например, `19`, `19-1`, `19-2`) — вычисляется из текста «строение X[/Y]»
- Этаж (`floor-0` — подвал, `floor-1`, `floor-2`, `floor-3` …) — определяется по заголовкам «N этаж», «Подвал» и положению строк
- Признак занятости + атрибуты аренды (контрагент, договор, сумма)

## «Синие» помещения (конфигурация)

Формат файла `blue-rooms-config.json`:

```json
{
  "blueRooms": [
    { "building": "building-19",   "floor": "floor-0", "rooms": ["1", "5б", "6а"] },
    { "building": "building-19-2", "floor": "floor-2", "rooms": ["27"] },
    { "building": "building-19-2", "floor": "floor-0", "rooms": ["3", "6"] }
  ]
}
```

Правила:

- `building` и `floor` строго в формате ключей интерфейса: `building-XX[-Y]`, `floor-N`
- `rooms` — список номеров. Допускаются кириллические буквы (а, б, в …). Латиница `a/b/c/d/e/o` автоматически переводится в кириллицу
- Если файл недоступен, используется резервная конфигурация из `script.js`

В момент окраски «синие» помещения имеют приоритет над статусом «свободно/занято». Для надёжности подсветка выполняется повторно с задержкой после загрузки SVG.

### «Особые» помещения

В `script.js` есть массив `specialRooms` — помещения, которые дополнительно выделяются (класс `.special-room`). Этот механизм независим от «синих» и используется, например, для постоянного выделения важных локаций.

Опционально можно добавить переключатель в интерфейс (если нужен):

```html
<div class="toggle-container">
  <label class="toggle-switch">
    <input type="checkbox" id="special-rooms-toggle" checked>
    <span class="slider round"></span>
  </label>
  <span>Показывать особые помещения</span>
  </label>
</div>
```

`script.js` уже содержит обработчик для `#special-rooms-toggle`.

## Правила для SVG

- Имена файлов: `floor_plan_svg/building-XX_floor-Y.svg`, где `XX` — номер строения (например, `19`, `19-1`, `19-2`), `Y` — номер этажа (`0` — подвал)
- Каждое помещение должно иметь id вида `room-<номер>` — пример: `room-101`, `room-12а`, `room-6б`
- Коридоры и служебные зоны помечайте `id="corridor"` или с префиксом `corridor_` — они игнорируются при кликах и окраске
- Внутри группы помещения допускаются любые фигуры (`rect`, `path`, `polygon`, `polyline`, `circle`, `ellipse`) — скрипт перекрасит их по состоянию

## Сопоставление данных с планом

1. Из `roomsData` формируется набор ключей для поиска (полный: номер+этаж+здание; упрощённый: номер+этаж; простой: номер)
2. Номер помещения нормализуется (цифры+буквы, перевод латиницы в кириллицу)
3. Приоритет сопоставления — точное совпадение (номер + `floor-*` + `building` как `19`, `19-2`), затем упрощённые варианты
4. Без данных помещение считается «свободным» (зелёное)

## Структура проекта

```
plan-Universal/
├── floor_plan_svg/
│   ├── building-19_floor-0.svg
│   ├── building-19_floor-1.svg
│   ├── building-19_floor-2.svg
│   ├── building-19-1_floor-1.svg
│   ├── building-19-1_floor-2.svg
│   ├── building-19-2_floor-0.svg
│   ├── building-19-2_floor-1.svg
│   ├── building-19-2_floor-2.svg
│   └── building-19-2_floor-3.svg
├── index.html
├── styles.css
├── script.js
├── blue-rooms-config.json
├── login.html
├── login.php
├── logout.php
├── index.php
├── .htaccess
├── google-apps-script.js
└── README.md
```

## Отладка и типовые проблемы

- «Синие» помещения не подсвечиваются:
  - Обновите страницу с очисткой кэша (Ctrl+F5). Загрузка конфига выполняется с параметром `?nocache`, но браузер всё равно может кешировать
  - Проверьте, что `blue-rooms-config.json` доступен по сети (статус 200) и валиден
  - Убедитесь, что значения `building`/`floor`/`rooms` соответствуют формату интерфейса
- Данные не приходят:
  - Проверьте значение `API_URL` в `script.js`
  - Убедитесь, что Apps Script опубликован как «Веб‑приложение» и доступен анонимно (либо настройте авторизованный доступ)
- Всегда «свободно»:
  - Значит, в данных не найдено сопоставление. Проверьте нормализацию номера и совпадение `floor-*` и номера строения
- SVG не загружается:
  - Проверьте путь/имя файла и наличие контейнера для активного здания/этажа
- Авторизация не работает без PHP:
  - Это ожидаемо. Для полной защиты требуется запуск через PHP (или собственный бэкенд)

## Безопасность

- Сразу измените пароль по умолчанию в `login.php`
- Не храните реальные токены доступа в репозитории. Если вы случайно закоммитили токен — немедленно отзовите его в соответствующем сервисе и перепроверьте историю коммитов

## Лицензия

Не указана. Добавьте файл `LICENSE`, если требуется распространение на условиях конкретной лицензии.


